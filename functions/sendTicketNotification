import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const user = await base44.auth.me();

        if (!user) {
            return Response.json({ error: 'Unauthorized' }, { status: 401 });
        }

        const { ticketData, customerName } = await req.json();

        // Get all users in Customer Service department
        const allUsers = await base44.asServiceRole.entities.User.list();
        const customerServiceUsers = allUsers.filter(u => 
            u.department && u.department.toLowerCase().includes('customer service')
        );

        if (customerServiceUsers.length === 0) {
            return Response.json({ message: 'No Customer Service users found to notify' });
        }
        
        const resendApiKey = Deno.env.get("RESEND_API_KEY");
        if (!resendApiKey) {
            return Response.json({ error: 'Resend API key not configured' }, { status: 500 });
        }

        // Collect all recipient emails into a single array for batch sending
        const recipientEmails = customerServiceUsers.map(csUser => csUser.email);

        // Construct a single email payload with multiple recipients
        const emailData = {
            from: 'AREA52 Support <noreply@tickets.area52.app>', // IMPORTANT: Replace with your verified Resend domain
            to: recipientEmails,
            subject: `New Support Ticket: ${ticketData.subject}`,
            html: `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #333;">New Support Ticket Created</h2>
                    
                    <div style="background-color: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <p><strong>Ticket #:</strong> ${ticketData.ticket_number}</p>
                        <p><strong>Customer:</strong> ${customerName}</p>
                        <p><strong>Subject:</strong> ${ticketData.subject}</p>
                        <p><strong>Type:</strong> ${ticketData.ticket_type}</p>
                        <p><strong>Urgency:</strong> ${ticketData.urgency}</p>
                        <p><strong>Status:</strong> ${ticketData.status}</p>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h3 style="color: #333;">Description:</h3>
                        <p style="background-color: #f9f9f9; padding: 15px; border-left: 4px solid #4f46e5; margin: 10px 0;">${ticketData.description}</p>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <p style="color: #666;">Please log into the AREA52 system to view and manage this ticket.</p>
                    </div>
                    
                    <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
                    <p style="color: #999; font-size: 12px;">This is an automated notification from AREA52 Support System.</p>
                </div>
            `
        };

        // Make a single API call to Resend with the batch payload
        const response = await fetch('https://api.resend.com/emails', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${resendApiKey}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(emailData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error(`Failed to send batch email:`, errorText);
            throw new Error(`Batch email failed: ${response.status} - ${errorText}`);
        }

        const result = await response.json();

        return Response.json({
            message: `Batch email notification successfully sent to ${recipientEmails.length} recipients.`,
            resendResponse: result,
        });

    } catch (error) {
        console.error('Ticket notification error:', error);
        return Response.json({ 
            error: 'Failed to send ticket notifications', 
            details: error.message 
        }, { status: 500 });
    }
});